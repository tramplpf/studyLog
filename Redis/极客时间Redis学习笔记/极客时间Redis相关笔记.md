# 极客时间Redis核心技术与实战

## 开篇词


### 04 AOF日志，宕机了，Redis如何避免数据丢失


### 05 内存快照： 宕机后，Redis如何实现快速恢复
Redis在使用RDB进行持久化时，Redis会fork子进程来完成。 fork操作的用时和Redis的数据量是正相关的，而fork在执行时会阻塞主线程。 数据量越大，fork操作造成的主线程阻塞的时间越长。


### 06 数据同步：主从库如何实现数据一致
* 要解决的问题：
1. 在Redis单实例中，Redis服务宕机之后，Redis在恢复期间提供的服务是不可用的

Redis的高可靠性包括如下两点
* 数据尽量少丢失  
    AOF 和RDB 保证了数据尽量少丢失
* 服务尽量少中断      
    Reids 通过增加副本冗余量来保证服务尽量少中断

Redis部署多套实例可能存在的问题
1. 多副本之间数据如何保持一致?
2. 数据读写操作可以发给所有的实例吗?

Redis提供了主从库模式，以保证数据副本的一致，主从库之间采用的是读写分离的方式。 

* 读操作：主库，从库都可以接收
* 写操作：首先到主库执行，然后，主库将写操作同步给从库



主从库间数据第一次同步的三个阶段
* 第一阶段： 建立连接，协商同步
* 第二阶段： 主库同步数据给从库
* 第三阶段： 主库发送新的写命令给从库


主从级联模式分担全量复制是的主库压力
我们可以通过“主-从-从”模式将主库生成RDB和传输RDB的压力，以级联的方式分散到从库上。 
在部署主从集群的时候，可以手动选择一个从库（比如选择内存资源配置较高的从库），用于级联其他的从库。然后，我们可以再选择一些从库，让这些从库从所选择的从库建立起主从关系。 


一旦主从库完成了全量复制，它们之间就会一直维护一个网络连接，主库会通过这个连接将后续陆续接收到的命名操作再同步给从库，这个过程也称为**基于长链接的命令传播**，可以避免频繁建立连接的开销。 


主从库网络断了怎么办？

## 重要的参数
* repl_backlog_size 


## 总结
* Redis的主从库同步的基本原理，总结来说，有三种模式： 全量复制，基于长连接的命名传播，以及增量复制



## 新引入的问题
主从库模式使用读写分离虽然避免了同时写入实例带来的数据不一致问题，但是还面临主库故障的潜在风险。 

## 课后问题
为什么主从库间的复制不使用 AOF 呢？
个人理解： 主从库复制，使用RDB而不使用AOF 是因为使用AOF 的话，传输的数据量比较大，网络带宽消耗比较大，不利于高性能。 







## 思考
* 如何查看Redis缓存的数据占用了多少内存？
* 有什么命令，可以临时断开两个机器中间的网络连接？
* 


### 07哨兵机制：主库挂了，如何不间断服务

#### 疑惑
1. 在微服务中访问Redis集群的时候，如何确定该读取Redis集群中的哪个数据？
2. 在Redis集群中，Redis的主节点变更之后，重启集群项目，是不是需要调整Redis连接的相关信息了 ？
3. 

#### 知识点
在Redis主从集群中，哨兵机制是实现主从库自动切换的关键机制，它有效地解决了主从复制模式下故障转移的三个问题
1. 主库真的挂了吗？
2. 该选择哪个从库作为主库
3. 怎么把新主库的相关信息通知给从库和客户端


哨兵其实就是一个运行在特殊模式下的Redis进程，主从库实例运行的同时，它也在运行。 
哨兵主要负责的就是三个任务： 监控，选主（选主主库），和通知。 

* 监控
  * 监控就是指哨兵进程在运行时，周期性的给所有的主从库发送PING命令，检测她们是否仍然在线运行。 
* 选主
* 通知


#### 如何选定新主库
筛选条件
   查看从库之前的网络连接状态
打分条件
* 从库优先级    
  第一轮： 优先级最高的从库得分高
* 从库复制进度
  * 和旧主库同步程度最接近的从库得分最高
* 从库ID号
  * 每个实例都会有一个ID，这个ID 就类似于这里的从库的编号。 
  * Redis在选主库时，有一个默认的规定，在优先级和复制进度都相同的情况下，ID号最小的从库得分最高，会被选为新主库。
* 




#### 重要的参数
slave-priority ： 给不同的从库设置不同的优先级

master_repl_offset： 主库用来记录当前在最新写操作在repl_backlog_buffer 中的位置
slave_repl_offset：  从库用来记录当前的复制进度。

#### 总结
Redis的哨兵机制，是实现Redis不间断服务的重要保证。具体来说，主从集群的数据同步，是数据可靠的基础保证，而在主库发生故障时，自动的主从切换时服务不间断的关键支撑。 

### 08 哨兵集群：哨兵挂了，主从库还能切换吗？



### 09 切片集群： 数据增多了，是该加内存还是加实例？
#### 需要解决的问题
* Redis如何保存更多数据？
* 数据如何存储到redis cluster上的
* 客户端如何定位数据在哪个实例上？

##### 相关命令
* 使用info命令查看Redis的 latest_fork_usec 指标值（表示最近一次fork的耗时）
* redis cluster中的命令： 
  * cluster create 创建集群
  * cluster meet 命令手动建立实例间的连接，形成集群，
  * cluster addslots 命令，指定每个实例上的哈希槽的个数
    * 这个命令，针对不同Redis实例，内存容量不一样的情况。
* MOVED 命令 ： 可以定位某个哈希槽所在Redis实例的ip和端口。 
  * MOVED 命令会更该本地缓存，让后续所有命令都发往新实例。 
* ASK 命令：表示哈希槽正在迁移过程中，没有完全迁移完。
  * ASK 命令并不会更新客户端缓存的哈希槽分配信息。 
* ASKING 命令： 

在实际应用Redis时，随着用户或业务规模的扩展，保持大量数据的情况通常是无法避免的，而切片集群，就是一个非常好的解决方案。 

切片集群不可避免地涉及到多个实例的分布式管理问题。 要想把切片集群用起来，我们需要解决两大问题
* 数据切片后，在多个实例之间如何分布
  * 从3.0 开始，Redis官方提供了一个名为Redis Clluster的方案，用于实现切换集群。Redis Cluster中规定了数据和实例的对应规则。 
  * Redis cluster中一共有16384个哈希槽
  * 在手动分配哈希槽的时候，需要把16384个槽都分配完，否则Redis集群无法正常工作。 
* 客户端怎么确定想要访问的数据在哪个实例上？
* 

通过哈希槽，切片集群实现了数据懂啊哈希槽，哈希槽再到实例的分配。

#### 客户端如何定位数据在哪个实例上


在集群中，实例和哈希槽的对应关系并不是一成不变的，最常见的变化有两个
1. 在集群中，实例有新增或删除，Redis需要重新分配哈希槽
2. 为了负载均衡，Redis需要把哈希槽在所有实例上重新分布一遍。 
   飞：如果这样，手动设置的哈希槽位置，是不是就发生改变了？
  
Redis Cluster 方案提供了一种重定向机制，所谓的重定向，就是指，客户端给一个实例发送数据读写操作时，这个实例上并没有相应的数据，客户端要再给一个新实例发送操作命令。 



## 基础篇
## 实战篇

### 11 万金油的String为什么不好用了

String类型并不是实用与所有的场合，它有一个明显的短板，就是它保存数据时所消耗的内存空间比较多。

#### 要解决的问题
* 为什么String类型内存开销大？
* 




#### String类型内存开销为什么大？
除了记录实际数据，String类型还需要额外的内存空间记录数据长度，空间使用等信息，这些信息也叫做元数据。点那个实际保存的数据较小时，元数据的空间开心就显得比较大了，优点喧宾夺主的意思。 

***当你保存64位有符号整数时，String类型会把它保存位一个8字节的Long类型整数，这种保存方式通常也叫做int编码方式***
但是当你保存的数据中包含字符串时，String类型就会用简单动态字符串（Simple Dynamic String， SDS） 结构体来保存。

SDS：
    buf：字节数组
    len：占4个字节
    alloc： 占4个字节
对于String类型来说，除了SDS的额外开销，还有一个来自RedisObject结构体的开销。 
一个ReidsObject包含了8个字节的元数据和一个8字节的字节指针，这个指针再进一步指向具体数据类型的实际数据所在。






### 12 有一亿个keys要统计，应该用哪种集合

#### 集合类型常见的四种统计模式
* 聚合统计
  * 所谓的聚合统计，就是指统计多个集合元素的聚合结果，包括： 统计多个集合的共有元素（交集）；
  * 把两个集合相比，统计其中一个集合独有的元素（差集统计）
  * 统计多个集合的所有元素（并集统计）
  * 对应的案例： 统计手机App每天的新增用户数和第二天的留存用户数。
  * Set 集合的差集，并集和交集复杂度较高，在数据量较大的情况下，如果直接执行这些计算，会导致Reids实例阻塞。 建议：可以从主从集群中选择一个从库，让它专门负责聚合计算，或者是把数据读取到客户端，在客户端来完成聚合统计。 
* 排序统计
  * 场景： 电商网站提供最新评论列表的功能， 最新评论列表包含了所有评论中的最新留言。 
  * List是按照元素进入List的顺序进行排序饿的，而Sorted Set可以根据元素的权重来排序，我们可以自己决定每个元素的权重值。
* 二值统计
  * 场景：签到打卡的场景
  * 二值状态就是指集合元素的取值就只有0和1 两种，在签到打卡的场景中，我们只用记录签到（1）或者未签到（0），是典型的非常典型的二值状态。 
  * Bitmap本身是用String类型作为底层数据结构实现的一种统计二值状态的数据类型。 
* 基数统计
  * 场景：基数统计就是指统计一个集合中不重复元素的个数，对应到我们的场景，就是统计网页的UV。 
  * HyperLogLog 是一种用于统计基数的数据集合类型，他的最大优势在于，当集合元素数量非常多时，它计算基数所需的空间总是固定的，而且还很小。 
  * 在Redis中，每个HyperLogLog 只需要花费12kb内存，就可以计算接近2^64个元素的基数。
  * 你可以用 PFADD 命令（用于向 HyperLogLog 中添加新元素）把访问页面的每个用户都添加到 HyperLogLog 中。
  * 接下来，就可以用 PFCOUNT 命令直接获得 page1 的 UV 值了，这个命令的作用就是返回 HyperLogLog 的统计结果
  * HyperLogLog 的统计规则是基于概率完成的，所以它给出的统计结果是有一定误差的，标准误算率是 0.81%。这也就意味着，你使用 HyperLogLog 统计的 UV 是 100 万，但实际的 UV 可能是 101 万。虽然误差率不算大，但是，如果你需要精确统计结果的话，最好还是继续用 Set 或 Hash 类型
  * 
* 



### 13 GEO时什么？ 还可以定义新的数据类型吗？
#### 问题
* 介绍开发自定义的新数据类型的基本步骤
* 扩展数据类型 GEO 的实现原理和使用方法
* LBS：基于位置信息服务  （Location-Based Service， LBS ）

飞： 感觉和自己关系不大，暂时不学习这一章节内容



### 14 如何在Redis中保存时间序列数据？
### 15 消息队列的考验：Redis有哪些解决方案
### 16 异步机制： 如何避免单线程模型的阻塞？
学习日期： 2022-11-06 星期日

#### 影响Redis性能的5大方面的潜在因素
* Redis 内部的阻塞式操作
* CPU 核核NUMA架构的影响
* Redus关键系统配置
* Redis内存碎片
* Redis缓冲区 



Redis内部阻塞操作的5类操作。 
Redis的5大交互对象。 




### 17 为什么CPU结构也会影响Redis的性能？

我们学习一下目前主流服务器的CPU架构，以及基于CPU多核架构和多CPU架构优化Redis性能的方法。 

我们可以使用 taskset 命令把一个程序绑定在一个核上运行。


### 18 波动的响应延迟： 如何应对慢的Redis？（上）

#### 判断Redis的响应是否变慢
* 查看Redis的响应延迟
  * redis-cli --latency -h host -p port 查看相应延迟
* 基于当前环境下的Redis基线性能做判断
  * 所谓的基线性能，就是一个系统在低压力，无干扰下的基本性能，这个性能只能由当前的软硬件配置决定
  * redis-cli --intrinsic-latency 可以用来检测和统计测试期间内的最大延迟，这个延迟可以作为Redis的基线性能。其中，测试时长可以用--intrinsic-latency 选项的参数来指定
  * redis-cli --intrinsic-latency 120  可以查看redis在120秒内的基线延迟
  * 基线性能和当前的操作系统，硬件配置相关。因此，我们可以把它和Redis运行时的延迟结合起来，再进一步判断Redis性能是否变慢
  * 如果观察到的Redis运行时的延迟时其基线性能的2倍以上，就可以认定Redis变慢了
  * 查看基线性能，应该在服务器端执行该命令，来避免网络对基线的性能影响
* 如果你想了解网络对 Redis 性能的影响，一个简单的方法是用 iPerf 这样的工具，测量从 Redis 客户端到服务器端的网络延迟。如果这个延迟有几十毫秒甚至是几百毫秒，就说明，Redis 运行的网络环境中很可能有大流量的其他应用程序在运行，导致网络拥塞了。这个时候，你就需要协调网络运维，调整网络的流量分配了

#### 如何应对Redis变慢？
在诊断Reids变慢这个病症时，你要基于自己对Redis本身的工作原理的理解，并且结合和它交互的操作系统，存储以及网络等外部系统关键机制，再借助一些辅助工具来定位原因，并制定行之有效的解决方案。 

* Redis 自身的操作特性，文件系统和操作系统，它们时影响Redis性能的三大要素。 

#### Redis自身操作特性对Redis变慢的影响
* 慢查询命令
  * 查看Redis所有命令的介绍 https://redis.io/commands/
  * 可以通过Redis日志或者latency monitor 工具，查询变慢的请求
  * 解决方法一：使用其他高效的命令代替。 例如使用ssscan 多次迭代返回数据，而不是使用smemners 命令
  * 解决方法二：当需要进行排序，交集，并集操作的时候，可以在客户端完成，而不要用sort，sunnion，sinter 这些命令，避免拖慢Redis实例
  * 注意： keys命令需要遍历存储的健值对，所以操作延时高。 所以，keys命令一般不被建议用于生产环境中。 
* 过期key操作
  * 过期key的自动删除机制。它是Redis用来回收内存空间的常用机制，应用广泛，本身就会引起Redis的操作阻塞，导致性能变慢。
  * Redis 键值对的 key 可以设置过期时间。默认情况下，Redis 每 100 毫秒会删除一些过期 key，
  * 具体的算法如下：采样 ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP 个数的 key，并将其中过期的 key 全部删除；
  * 如果超过 25% 的 key 过期了，则重复删除的过程，直到过期 key 的比例降至 25% 以下。

要真正把Redis用好，除来要了解Redis本身的原理，还要了解和Redis交互的各底层系统的关键机制，包括操作系统和文件系统。 
通常情况下，一些难以排查的问题是Redis的用法或设置和底层系统的工作机制不协调导致的。 


### 19 波动的响应延迟：如何应对满的Redis（下）
### 20 删除数据后，为什么内存占用率还是很高？
### 21 缓冲区：一个可能引发惨案的地方
### 22: 11-21讲课后思考答案

## 未来篇
## 加餐篇


## Redis可以解决的业务问题
* 在移动应用中，需要统计每天的新增用户数和第二天的留存用户数
* 载电商网站的商品评论中，需要统计评论列表中的最新评论
* 在签到打卡中，需要统计一个月内连续打卡的用户数
  * 如果记录了1亿个用户10天的签到情况，你有办法统计出这10天连续签到的用户总数吗？
* 载网页访问记录中，需要统计独立博客访客量（unique Visitor， UV）。
