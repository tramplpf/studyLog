# mysql8的备份与恢复



## 生产中备份和恢复的方式

逻辑备份： mysqldump

物理备份：xtrabackup

* 备份速度快，占用更多的存储空间

增量备份： binlog

clone plugin：远程备份数据



日常备份管理

* 备份空间是否充足
* 备份文件是否存在
* 定期恢复演练



### 备份案例

**案例**： 备份当前实例下的所有数据库

```shell
[root@node03 ~]# mysqldump -uroot -p -S /opt/data/mysql/socket/mysql3306.sock -A -E -R --triggers --master-data=2 --single-transaction > /opt/data/mysqlbackup/backup/allbackup/20250907/all_3306_20250907.sql
WARNING: --master-data is deprecated and will be removed in a future version. Use --source-data instead.
Enter password: 

```

参数解释：

-A 表示备份实例下的所有数据库



**案例**：备份当前实例下的指定数据库

```shell
$> mysqldump -uroot -p -S /opt/data/mysql/socket/mysql3306.socket -B stock -R -E --triggers --maser-data=2 --single-transaction > /opt/mysql/backup/alldb/stock/20250907/.stock_3306_`date+%Y%m%d`.sql
```

参数解释：

-B 指定备份哪个数据库



**案例**： 备份指定数据库中的一张表

```shell
$> mysqldump -uroot -p -S /opt/data/mysql/socket/mysql3306.socket stock app_hq_level2_dtl -R -E --triggers --master-data=2 --single-transaction > /opt/mysql/backup/db_tables/stock/20250907/.app_hq_level2_dtl_3306_`date+%Y%m%d`.sql
```





备份文件命名方式： 数据库名+端口+日期.sql



### mysqldump备份的原理

* flush tables;  打开所有打开的表
* flush tables with read lock;  为数据库加全局读锁
* set session transaction isoloation level repeatable read;  将隔离级别设置为RR
* start transaction;  开启事务
* show master status； 获取正在使用的二进制文件
* unlock tables： 释放全局读锁， 这是数据库就可以进行写操作了
* show create database db; 
* savepoint sp;  设置回滚点
* show create tables stock;
* select * from stock;
* rollback to sp;  回滚到sp回滚点
* release savepoint sp;



备份恢复案例：利用mysqldump全备及binlog恢复数据

**案例**: 下午16点删除库，怎么利用全备及binlog去恢复数据

**操作:**

* 利用全备恢复之前的数据
  * set session sql_log_bin=0;  临时关闭二进制日志，写操作不保存到二进制文件中
  * mysql -uroot -p -S /opt/data/mysql/socket/mysql3306.socket < stock_3306_20250907.sql
* 利用binlog恢复数据
  * mysqlbinlog --base64-output=decode=rows -vv  /opt/data/mysql/data/3306

