# mysql的逻辑备份与恢复



## 定义

mysql的逻辑备份是指将数据库的结构()和数据() 以SQL语句的形式导出到一个文本文件中的过程。这个文件可以被用来在另一个MySQL服务器上重建**整个数据库**



## 核心工具mysqldump



## 常用备份场景实例



### 备份单个数据库(不包括系统库本身)

```shell
# 交互式输入密码(推进，一种安全的操作方式)
$> mysqldump -uroot -p 数据库名称 > database_backup_20250918.sql

生产环境实际执行命令:
$> mysqldump -uroot -p -S /opt/data/mysql/socket/mysql3306.sock  --single-transaction --set-gtid-purged=OFF --triggers --routines --events db > /opt/data/mysqlbackup/backup/database/db/20250918/db.sql
```



### 备份单个数据库(包括创建数据库的语句)

默认情况下，mysqldump不会包含 create database 语句。 使用 --databases 或-B 选项可以包含它。 这在恢复是不需要先手动创建数据库

```shell
$> mysqldump -uroot -p --databases 数据库名称 > database名称_backup_20250918.sql
```



### 备份所有数据库(完整备份)

使用 --all-databases 选项。 这会备份mysql，sys等系统库和你自己创建的所有库。

```shell
$> mysqldump  -uroot -p --all-databases >  all_database_backup_20250918.sql

实际执行的命令：
$> mysqldump -uroot -p -S /opt/data/mysql/socket/mysql3306.sock --single-transaction --all-databases --triggers --routines --events  > /opt/data/mysqlbackup/backup/allbackup/20250918/all.sql

```



### 只备份数据库结构(不备份数据)

使用 --no-data 选项

```shell
$> mysqldump -uroot -p --no-data 数据库名称 > 数据库名称_backup_20250918.sql
```



## 只备份数据(不备份结构)

使用 --no-create-info 选项

```shell
$> mysqldump -uroot -p --no-create-info 数据库名称 > 数据库名称_backup_20250918.sql
```



### 备份特定的表

```shell
$> mysqldump -uroot -p 数据库名称 表名1 表名2 > 数据库名_表名_backup_20250918.sql 
```



## 重要高级选项

*  --single-transaction:  **极其重要**。对于InnoDB存储引擎的表，此选项在备份开始前会启动一个事物，确保得到一份一致性的快照，**备份过程不会锁表**，非常适合生产环境。对于 InnoDB表，强烈推进使用此选项。  <font color="red">如何确定备份时是哪个事务点</font>，下次增量备份的时候，该从哪里开始。 (逻辑备份有增量备份之说吗？)

* --routines ：备份存储过程和函数

* --events 备份事件调度器

* --triggers：备份触发器(默认已开启)

* --hex-blob： 安全备份二进制数据 (BLOB, BINARY)

* --add-drop-database/table: 在创建语句前添加删除语句，确保干净恢复

  

  

  生成环境推荐命令

  ```shell
  $> mysqldump -uroot -p --single-transaction --routines --events --triggers --hex-blob --all-databases > ip_端口_日期.sql
  ```

* 



## 恢复备份

**命令行恢复**

```shell
$> mysql -uroot -p < ip_端口_日期.sql
```



**Mysql Shell 内恢复**

```mysql
mysql> create database db;
mysql> use db;
mysql> source /path/to/backup.sql
```



## 自动化备份脚本实例



## 注意实现

* 对于TB级别数据库，逻辑备份可能不适用。应考虑物理备份工具(如 XtraBackup)
* 不要将备份sql保存到和数据库同一个磁盘上。 避免磁盘损坏时，数据库和备份文件都收到损坏





## 遇到的问题

1、 Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events.

```text
含义：
GTID的作用：
GTID是MySQL中用于标识事务的唯一标识符，能够简化主从复制和故障恢复。当服务器启用GTID时，mysqldump默认会包含所有事务的GTID信息，即使这些事务仅涉及被排除的部分数据库。
警告原因：
如果备份的是部分数据库或表，而服务器启用了GTID，备份文件中仍会包含所有事务的GTID信息。这可能导致在恢复时引入不必要的事务信息。
解决方案：
如果不希望恢复GTID信息，可以使用--set-gtid-purged=OFF选项。
如果需要完整的数据库备份（包括所有数据库、触发器、存储过程和事件），可以使用--all-databases --triggers --routines --events选项。
```







## todo





## 变更记录

| 日期              | 类型 | 操作内容                                                     | 备注                   | 接下来验证的内容                       | 操作用户 |
| ----------------- | ---- | ------------------------------------------------------------ | ---------------------- | -------------------------------------- | -------- |
| 2024-04-13 星期六 | C    | 练习pg_dump命令                                              | xxx                    | pg_dump 一些参数使用存在疑惑，需要解决 | lipf     |
| 2024-04-13 星期六 | U    | 修改模板，新增一个类型列                                     | 用来说明修改文件的原由 |                                        | lipf     |
| 2025-05-19 星期一 | A    | 新增一个其他知识的章节，记录学习过程中了解到的和主题关系不大的知识 |                        |                                        |          |
|                   |      |                                                              |                        |                                        |          |

类型说明： C：创建    A： 最近内容    U：修改内容     R：解决疑惑点