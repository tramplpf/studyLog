# mysql用户及权限管理

## 大纲

```text
1、MySQL用户管理
2、MySQL用户权限管理
3、你必须知道的mysql用户知识
4、生产中mysql用户权限案例
* 某个用户已经被删除了，但是已经链接进来的某个用户是不受影响的。  那么如何清理掉这些用户，断开链接呢？
* 忘记密码如何处理
* 如何禁止一个ip段的用户登录
* 创建开发账号
* 创建复制账号
* 查看当前链接的用户是谁及权限
* 查看当前有多少连接进来
* 查看哪些用户连接
* 查看每个用户有多少个连接进来
```



## 查看当前登录用户

```sql
mysql> select current_user();
mysql> select user();
```



## mysql用户管理

```shell
## 创建用户
mysql> crate user gaoy@'%' identified by 'gaoy';

# 删除用户
mysql> drop user gao@'%';

## 修改用户名：
select  user, host from mysql.user;
update mysql.user set host = '192.168.23.129' where xxx

## 修改密码
mysql> alter user gaoy@'%' identified by '123456';

// TODO 这里需要明确一下，具体的命令是什么样的？
$> mysqladmin -u -p -S password 'gao';

## 查询用户
mysql> select user, host from mysql.user;  # 查询已经创建的用户
mysql> select current_user();  # 查看当前登录用户

```



注意：

通过update 修改mysql.user 表中的用户名后，直接登录，修改效果没有生效。  需要通过 flush privileges 命令来使数据从磁盘进入内容。 



原因： 

a. update在执行修改用户时，是将数据保存到磁盘上的。 

b. 通过连接mysql数据库，会进行一系列的认证（用户名,ip,密码）， 会从内存中读取数据与我们连接时输入的数据进行匹配。 



## mysql用户权限管理

新增：

```sql
mysql> grant show databases on *.* to lipf@'%';

给用户添加权限后，已经连接的权限没有改变， 添加的新权限不会影响已连接用户
```

查询：



回收：

```sql
mysql> revoke show databases on *.* from lipf@'%';
```





## 连接

查看当前有哪些连接

```sql
mysql> show processlist;


## 断开指定连接
mysql> kill id值； 


## 批量端口多个id值,拼接sql
mysql> use information_schema;
mysql> select concat('kill', id, ';') from processlist where user = 'lipf';
### 拼接得到sql后，执行多个sql

```









## 遇到的问题

1.

mysql> select concat('kill ', id ,';' ) from processlist into outfile '/tmp/kill.sql';
ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement
mysql> 

解决方案：

### 1. 错误原因：`--secure-file-priv` 选项是什么？

`--secure-file-priv` 是 MySQL 服务器启动时的一个安全参数。它的主要目的是防止数据库用户通过 `INTO OUTFILE` 或 `LOAD DATA INFILE` 语句，对服务器文件系统的任意位置进行读写操作，从而避免潜在的安全风险（例如，覆盖系统关键文件或将敏感数据写入可被 web 访问的目录）。

这个参数可以有以下几种状态：

- `secure-file-priv = "一个具体的路径"` (例如 `/var/lib/mysql-files/`)
  - 这是最常见的配置。它表示 `INTO OUTFILE` 和 `LOAD DATA INFILE` **只能**在指定的目录下操作。你试图写入的 `/tmp/` 目录不在这个允许的路径内，因此操作被拒绝。
- `secure-file-priv = ""` (空字符串)
  - 这个配置表示**禁用**了该安全限制。文件可以被写入到服务器上任何有写权限的目录。**这非常不安全，不推荐在生产环境中使用。**
- `secure-file-priv = NULL` (未设置或显式设为 NULL)
  - 这个配置表示**完全禁止**使用 `INTO OUTFILE` 和 `LOAD DATA INFILE` 语句。任何尝试都会直接报错。

你的错误表明，你的 MySQL 服务器正处于第一种情况，即 `secure-file-priv` 被设置为了一个非 `/tmp/` 的特定目录。

------

### 2. 解决方案 (todo)

#### 方案一：找到并使用 `secure-file-priv` 指定的目录（推荐）

这是最安全、最标准的解决方法，因为它遵循了服务器的安全策略。

**步骤 1：查询 `secure-file-priv` 的当前值**

在 MySQL 命令行中执行以下命令：

sql

复制

```
SHOW VARIABLES LIKE 'secure_file_priv';
```

你可能会看到类似下面的输出：



复制

```
+------------------+-----------------------+
| Variable_name    | Value                 |
+------------------+-----------------------+
| secure_file_priv | /var/lib/mysql-files/ |
+------------------+-----------------------+
```

这里的 `/var/lib/mysql-files/` 就是 MySQL 允许你写入文件的唯一目录。**请记下这个路径。**

**步骤 2：修改你的 SQL 语句，使用正确的路径**

现在，将你原来的 SQL 语句中的 `/tmp/kill.sql` 替换为你刚刚查到的路径。

sql

复制

```
-- 假设查到的路径是 /var/lib/mysql-files/
SELECT CONCAT('KILL ', id, ';') FROM information_schema.PROCESSLIST INTO OUTFILE '/var/lib/mysql-files/kill.sql';
```

**重要提示：**

- **目录权限**：确保运行 MySQL 服务的系统用户（通常是 `mysql`）对这个目录有写权限。通常这个目录在 MySQL 安装或初始化时就已经被正确设置了。
- **文件覆盖**：`INTO OUTFILE` **不能**覆盖已存在的文件。如果 `/var/lib/mysql-files/kill.sql` 文件已经存在，这条语句会报错。你需要先删除旧文件，或者使用一个新的文件名。

sql

复制

```
    -- 在系统 shell 中删除旧文件（需要相应权限）
    -- $ rm /var/lib/mysql-files/kill.sql
```

- **文件内容**：`INTO OUTFILE` 生成的文件默认由制表符（Tab）分隔，并且每行以换行符结尾。对于你生成 `KILL` 语句的场景，这恰好是理想的效果。

**步骤 3：执行生成的 SQL 文件**

文件成功生成后，你可以在系统的命令行（shell）中，使用 `mysql` 客户端来执行这个脚本文件。

bash

复制

```
# -u 用户名, -p 密码
mysql -u root -p < /var/lib/mysql-files/kill.sql
```

![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAsVBMVEVHcEzm6PHl6fHm6vLm6fLm6fHm6fLm6vLk6PHf3+/m6vHm6fLn5/fn6/Pn5/Pl6vLn5+/f7+/m6/Pm6vPf3//l6fHk6vLl5/Hm6fHl6PHn6vLm6fHo6vTl6fPm5vHn5/Lk5/Lm6/Hn6/Pm6fPm6vEaICnm6fJna3TN0NnZ3OU0OULNz9lNUluAhI0nLTZzeIFARU5zd4CAhY6zt7+mqrNaX2iZnqdARk/AxM2zt8CZnaYyn2x3AAAAJXRSTlMAcIC/39+v75AQ7+8gQECfIBCPjxDPYIDPsJ+gb89wYGBwf8/PXr3f9QAAAWdJREFUOMuNldd2gzAQREXvBuLgEqcniGLAxOn5/w+LigGJJuZpfPYejSRWawA4eU+6ZkBoRLrsgUldPyOmk+q749gaDjSG3hpwROqmz63hhK74WAVOKrIY8A7OSFmQ20vfQIEkyrmqCHToNm+gUCTchQtk9RZ8/8zjOCM2K4sqTpqCjEBmh6cY64jtT45tCzoArDqujFswJVwHQg/Irc9IsUhw9Be21emXuSG99R+4WFP/jWyeMrvfgxc+uaSerM21Eei6K8HVP7qLAegAyINVjddMyVHyggnvgzG5x/Ri3xjQGIDHDkyYaHUZ+Mpczyy4B9IyUGY+4SyIxoHBtwQ5ddY/tYa6Z9v8oI1QnbE/E65u79FHYLikcQPc4qaY88mbCQ0RpwX0Gd6LwMfmYQvCzW5UKHNcxMyecDczeixunpkLcqketDHMloYjNziMLGeNTvHgwK1qb63pP4aVrO9sxGi6tOIr/4xNt/ViQm5CAAAAAElFTkSuQmCC)

引用

输入密码后，文件中的所有 `KILL` 语句就会被执行









